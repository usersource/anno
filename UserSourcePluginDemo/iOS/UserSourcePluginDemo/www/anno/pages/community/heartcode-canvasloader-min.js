/*
* Copyright (c) 2011 RÃ³bert Pataki
* 
* Permission is hereby granted, free of charge, to any person obtaining a copy
* of this software and associated documentation files (the "Software"), to deal
* in the Software without restriction, including without limitation the rights
* to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
* copies of the Software, and to permit persons to whom the Software is
* furnished to do so, subject to the following conditions:
* 
* The above copyright notice and this permission notice shall be included in
* all copies or substantial portions of the Software.
* 
* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
* IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
* FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
* AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
* LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
* OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
* THE SOFTWARE.
* 
* ----------------------------------------------------------------------------------------
* 
* Check out my GitHub:	http://github.com/heartcode/
* Send me an email:		heartcode@robertpataki.com
* Follow me on Twitter:	http://twitter.com/#iHeartcode
* Blog:					http://heartcode.robertpataki.com
*//**
* CanvasLoader uses the HTML5 canvas element in modern browsers and VML in IE6/7/8 to create and animate the most popular preloader shapes (oval, spiral, rectangle, square and rounded rectangle).<br/><br/>
* It is important to note that CanvasLoader doesn't show up and starts rendering automatically on instantiation. To start rendering and display the loader use the <code>show()</code> method.
* @module CanvasLoader
**/(function(a){"use strict";var b=function(a,b){typeof b=="undefined"&&(b={}),this.init(a,b)},c=b.prototype,d,e=["canvas","vml"],f=["oval","spiral","square","rect","roundRect"],g=/^\#([a-fA-F0-9]{6}|[a-fA-F0-9]{3})$/,h=navigator.appVersion.indexOf("MSIE")!==-1&&parseFloat(navigator.appVersion.split("MSIE")[1])===8?!0:!1,i=!!document.createElement("canvas").getContext,j=40,k=!0,l=function(a,b,c){var d=document.createElement(a),e;for(e in c)d[e]=c[e];return typeof b!="undefined"&&b.appendChild(d),d},m=function(a,b){for(var c in b)a.style[c]=b[c];return a},n=function(a,b){for(var c in b)a.setAttribute(c,b[c]);return a},o=function(a,b,c,d){a.save(),a.translate(b,c),a.rotate(d),a.translate(-b,-c),a.beginPath()};c.init=function(a,c){typeof c.safeVML=="boolean"&&(k=c.safeVML);try{document.getElementById(a)?this.mum=document.getElementById(a):this.mum=document.body}catch(f){this.mum=document.body}c.id=typeof c.id!="undefined"?c.id:"canvasLoader",this.cont=l("div",this.mum,{id:c.id});if(i)d=e[0],this.can=l("canvas",this.cont),this.con=this.can.getContext("2d"),this.cCan=m(l("canvas",this.cont),{display:"none"}),this.cCon=this.cCan.getContext("2d");else{d=e[1];if(typeof b.vmlSheet=="undefined"){document.getElementsByTagName("head")[0].appendChild(l("style")),b.vmlSheet=document.styleSheets[document.styleSheets.length-1];var g=["group","oval","roundrect","fill"],h;for(var h=0;h<g.length;++h)b.vmlSheet.addRule(g[h],"behavior:url(#default#VML); position:absolute;")}this.vml=l("group",this.cont)}this.setColor(this.color),this.draw(),m(this.cont,{display:"none"})},c.cont={},c.can={},c.con={},c.cCan={},c.cCon={},c.timer={},c.activeId=0,c.diameter=40,c.setDiameter=function(a){this.diameter=Math.round(Math.abs(a)),this.redraw()},c.getDiameter=function(){return this.diameter},c.cRGB={},c.color="#000000",c.setColor=function(a){this.color=g.test(a)?a:"#000000",this.cRGB=this.getRGB(this.color),this.redraw()},c.getColor=function(){return this.color},c.shape=f[0],c.setShape=function(a){var b;for(b in f)if(a===f[b]){this.shape=a,this.redraw();break}},c.getShape=function(){return this.shape},c.density=40,c.setDensity=function(a){k&&d===e[1]?this.density=Math.round(Math.abs(a))<=j?Math.round(Math.abs(a)):j:this.density=Math.round(Math.abs(a)),this.density>360&&(this.density=360),this.activeId=0,this.redraw()},c.getDensity=function(){return this.density},c.range=1.3,c.setRange=function(a){this.range=Math.abs(a),this.redraw()},c.getRange=function(){return this.range},c.speed=2,c.setSpeed=function(a){this.speed=Math.round(Math.abs(a))},c.getSpeed=function(){return this.speed},c.fps=24,c.setFPS=function(a){this.fps=Math.round(Math.abs(a)),this.reset()},c.getFPS=function(){return this.fps},c.getRGB=function(a){return a=a.charAt(0)==="#"?a.substring(1,7):a,{r:parseInt(a.substring(0,2),16),g:parseInt(a.substring(2,4),16),b:parseInt(a.substring(4,6),16)}},c.draw=function(){var a=0,b,c,g,i,j,k,p,q,r=this.density,s=Math.round(r*this.range),t,u=0,v,w,x,y,z=1e3,A=0,B=this.cCon,C=this.diameter,D=.47;if(d===e[0]){B.clearRect(0,0,z,z),n(this.can,{width:C,height:C}),n(this.cCan,{width:C,height:C});while(a<r){t=a<=s?1-(1-u)/s*a:t=u,k=270-360/r*a,p=k/180*Math.PI,B.fillStyle="rgba("+this.cRGB.r+","+this.cRGB.g+","+this.cRGB.b+","+t.toString()+")";switch(this.shape){case f[0]:case f[1]:b=C*.07,i=C*D+Math.cos(p)*(C*D-b)-C*D,j=C*D+Math.sin(p)*(C*D-b)-C*D,B.beginPath(),this.shape===f[1]?B.arc(C*.5+i,C*.5+j,b*t,0,Math.PI*2,!1):B.arc(C*.5+i,C*.5+j,b,0,Math.PI*2,!1);break;case f[2]:b=C*.12,i=Math.cos(p)*(C*D-b)+C*.5,j=Math.sin(p)*(C*D-b)+C*.5,o(B,i,j,p),B.fillRect(i,j-b*.5,b,b);break;case f[3]:case f[4]:c=C*.3,g=c*.27,i=Math.cos(p)*(g+(C-g)*.13)+C*.5,j=Math.sin(p)*(g+(C-g)*.13)+C*.5,o(B,i,j,p),this.shape===f[3]?B.fillRect(i,j-g*.5,c,g):(q=g*.55,B.moveTo(i+q,j-g*.5),B.lineTo(i+c-q,j-g*.5),B.quadraticCurveTo(i+c,j-g*.5,i+c,j-g*.5+q),B.lineTo(i+c,j-g*.5+g-q),B.quadraticCurveTo(i+c,j-g*.5+g,i+c-q,j-g*.5+g),B.lineTo(i+q,j-g*.5+g),B.quadraticCurveTo(i,j-g*.5+g,i,j-g*.5+g-q),B.lineTo(i,j-g*.5+q),B.quadraticCurveTo(i,j-g*.5,i+q,j-g*.5))}B.closePath(),B.fill(),B.restore(),++a}}else{m(this.cont,{width:C,height:C}),m(this.vml,{width:C,height:C});switch(this.shape){case f[0]:case f[1]:x="oval",b=z*.14;break;case f[2]:x="roundrect",b=z*.12;break;case f[3]:case f[4]:x="roundrect",b=z*.3}c=g=b,i=z*.5-g,j=-g*.5;while(a<r){t=a<=s?1-(1-u)/s*a:t=u,k=270-360/r*a;switch(this.shape){case f[1]:c=g=b*t,i=z*.5-b*.5-b*t*.5,j=(b-b*t)*.5;break;case f[0]:case f[2]:h&&(j=0,this.shape===f[2]&&(i=z*.5-g*.5));break;case f[3]:case f[4]:c=b*.95,g=c*.28,h?(i=0,j=z*.5-g*.5):(i=z*.5-c,j=-g*.5),A=this.shape===f[4]?.6:0}w=n(m(l("group",this.vml),{width:z,height:z,rotation:k}),{coordsize:z+","+z,coordorigin:-z*.5+","+ -z*.5}),v=m(l(x,w,{stroked:!1,arcSize:A}),{width:c,height:g,top:j,left:i}),y=l("fill",v,{color:this.color,opacity:t}),++a}}this.tick(!0)},c.clean=function(){if(d===e[0])this.con.clearRect(0,0,1e3,1e3);else{var a=this.vml;if(a.hasChildNodes())while(a.childNodes.length>=1)a.removeChild(a.firstChild)}},c.redraw=function(){this.clean(),this.draw()},c.reset=function(){typeof this.timer=="number"&&(this.hide(),this.show())},c.tick=function(a){var b=this.con,c=this.diameter;a||(this.activeId+=360/this.density*this.speed),d===e[0]?(b.clearRect(0,0,c,c),o(b,c*.5,c*.5,this.activeId/180*Math.PI),b.drawImage(this.cCan,0,0,c,c),b.restore()):(this.activeId>=360&&(this.activeId-=360),m(this.vml,{rotation:this.activeId}))},c.show=function(){if(typeof this.timer!="number"){var a=this;this.timer=self.setInterval(function(){a.tick()},Math.round(1e3/this.fps)),m(this.cont,{display:"block"})}},c.hide=function(){typeof this.timer=="number"&&(clearInterval(this.timer),delete this.timer,m(this.cont,{display:"none"}))},c.kill=function(){var a=this.cont;typeof this.timer=="number"&&this.hide(),d===e[0]?(a.removeChild(this.can),a.removeChild(this.cCan)):a.removeChild(this.vml);var b;for(b in this)delete this[b]},a.CanvasLoader=b})(window);